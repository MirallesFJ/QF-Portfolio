import streamlit as st, pandas as pd, numpy as np
from scipy.stats import chi2
from app import load_csv, compute_var

st.title("VaR Backtest — Kupiec POF")

src = st.sidebar.radio("Data", ["Sample CSV", "Upload"])
alpha = st.sidebar.select_slider("Confidence (α)", [0.90, 0.95, 0.99], value=0.95)
method = st.sidebar.selectbox("VaR method", ["historical", "parametric"])

if src == "Sample CSV":
    df = load_csv("data/AAPL.csv")
else:
    up = st.sidebar.file_uploader("CSV (date, ret)", type=["csv"])
    if not up:
        st.stop()
    df = pd.read_csv(up, parse_dates=["date"]).sort_values("date")

r = df["ret"].astype(float).dropna()
var = compute_var(r, alpha, method)
viol = (r < -var).sum()
n = len(r)
pi_hat = viol / n
pi_0 = 1 - alpha
# Kupiec likelihood ratio
LR = -2 * (
    (n - viol) * np.log(1 - pi_0)
    + viol * np.log(pi_0)
    - (n - viol) * np.log(1 - pi_hat if pi_hat > 0 else 1)
    - (viol * np.log(pi_hat) if pi_hat > 0 else 0)
)
pval = 1 - chi2.cdf(LR, df=1)

c1, c2, c3 = st.columns(3)
c1.metric("Violations", str(viol))
c2.metric("Expected viol.", f"{n * pi_0:.1f}")
c3.metric("p-value", f"{pval:.3f}")
st.caption("Low p-value → reject VaR model calibration.")
